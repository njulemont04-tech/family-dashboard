{% extends "base.html" %} {% block title %}{{ _('Calendar') }} - {{ super() }}{%
endblock %} {% block content %}

<!-- ================================================================== -->
<!-- START: RESPONSIVE CALENDAR HEADER (No changes here)              -->
<!-- ================================================================== -->

<!-- 1. Mobile Header: Displays the "Calendar" title and a back button -->
<div class="feature-header d-flex d-md-none align-items-center mb-4">
  <a href="{{ url_for('home') }}" class="feature-header-back-button">
    <i class="bi bi-arrow-left"></i>
  </a>
  <h1 class="feature-header-title h2 mb-0">{{ _('Calendar') }}</h1>
</div>

<!-- 2. Desktop Header: Displays ONLY the month/year and navigation controls -->
<div class="d-none d-md-flex justify-content-between align-items-center mb-4">
  <h1 class="h2 mb-0">{{ current_date.strftime('%B %Y') }}</h1>
  <div class="btn-group">
    <a
      href="{{ url_for('calendar_view', year=prev_month_date.year, month=prev_month_date.month) }}"
      class="btn btn-outline-primary"
    >
      <i class="bi bi-chevron-left"></i> {{ _('Previous') }}
    </a>
    <a href="{{ url_for('calendar_view') }}" class="btn btn-outline-secondary"
      >{{ _('Today') }}</a
    >
    <a
      href="{{ url_for('calendar_view', year=next_month_date.year, month=next_month_date.month) }}"
      class="btn btn-outline-primary"
    >
      {{ _('Next') }} <i class="bi bi-chevron-right"></i>
    </a>
  </div>
</div>

<!-- 3. Mobile Sub-Header: Displays the month/year and navigation below the main title -->
<div class="d-flex d-md-none justify-content-between align-items-center mb-4">
  <h2 class="h4 mb-0">{{ current_date.strftime('%B %Y') }}</h2>
  <div class="btn-group">
    <a
      href="{{ url_for('calendar_view', year=prev_month_date.year, month=prev_month_date.month) }}"
      class="btn btn-sm btn-outline-primary"
    >
      <i class="bi bi-chevron-left"></i>
    </a>
    <a
      href="{{ url_for('calendar_view') }}"
      class="btn btn-sm btn-outline-secondary"
      >{{ _('Today') }}</a
    >
    <a
      href="{{ url_for('calendar_view', year=next_month_date.year, month=next_month_date.month) }}"
      class="btn btn-sm btn-outline-primary"
    >
      <i class="bi bi-chevron-right"></i>
    </a>
  </div>
</div>

<!-- ================================================================== -->
<!-- END: RESPONSIVE CALENDAR HEADER                                  -->
<!-- ================================================================== -->

<!-- ================================================================== -->
<!-- START: DESKTOP CALENDAR GRID (Visible on lg screens and up)      -->
<!-- ================================================================== -->
<div class="d-none d-lg-block">
  <div class="table-responsive">
    <table class="table table-bordered calendar-grid">
      <thead>
        <tr class="text-center">
          <th>{{ _('Monday') }}</th>
          <th>{{ _('Tuesday') }}</th>
          <th>{{ _('Wednesday') }}</th>
          <th>{{ _('Thursday') }}</th>
          <th>{{ _('Friday') }}</th>
          <th>{{ _('Saturday') }}</th>
          <th>{{ _('Sunday') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for week in month_calendar %}
        <tr>
          {% for day_date in week %} {% set is_today = (day_date == today) %} {%
          set is_current_month = (day_date.month == current_date.month) %}
          <td
            class="calendar-day {% if not is_current_month %}other-month{% endif %} {% if is_today %}today{% endif %}"
            data-bs-toggle="modal"
            data-bs-target="#addEventModal"
            data-date="{{ day_date.strftime('%Y-%m-%d') }}"
          >
            <div class="day-number">{{ day_date.day }}</div>
            <div class="events-container">
              {% for event in events_by_day.get(day_date.day, []) %} {# This
              check is crucial for days like '1' which can appear from prev/next
              month #} {% if event.date == day_date %}
              <div
                class="event-badge"
                id="event-{{ event.id }}"
                data-bs-toggle="modal"
                data-bs-target="#viewEventModal"
                data-event-id="{{ event.id }}"
                data-event-title="{{ event.title }}"
                data-event-time="{{ event.time.strftime('%H:%M') }}"
                data-event-author="{{ event.author.username }}"
                data-event-author-id="{{ event.author_id }}"
              >
                <span class="event-time"
                  >{{ event.time.strftime('%H:%M') }}</span
                >
                {{ event.title }}
              </div>
              {% endif %} {% endfor %}
            </div>
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<!-- ================================================================== -->
<!-- END: DESKTOP CALENDAR GRID                                       -->
<!-- ================================================================== -->

<!-- ================================================================== -->
<!-- START: MOBILE CALENDAR VIEW (Visible on screens smaller than lg) -->
<!-- ================================================================== -->
<div class="d-lg-none">
  <!-- JavaScript will render the compact month grid here -->
  <div id="mobile-month-navigator" class="mb-4"></div>

  <!-- JavaScript will render the event list for the selected day here -->
  <div id="mobile-agenda-list"></div>
</div>
<!-- ================================================================== -->
<!-- END: MOBILE CALENDAR VIEW                                        -->
<!-- ================================================================== -->

<!-- ================================================================== -->
<!-- START: MODALS & FORMS (Unchanged, used by both views)            -->
<!-- ================================================================== -->
<!-- Add Event Modal -->
<div
  class="modal fade"
  id="addEventModal"
  tabindex="-1"
  aria-labelledby="addEventModalLabel"
  aria-hidden="true"
  data-bs-backdrop="static"
  data-bs-keyboard="false"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form
        id="add-event-form"
        action="{{ url_for('add_event') }}"
        method="POST"
      >
        <div class="modal-header">
          <h5 class="modal-title" id="addEventModalLabel">
            {{ _('Add Event') }}
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <!-- The date is now set by JavaScript, so this input is hidden -->
          <input type="hidden" id="event-date-input" name="date" value="" />

          <div class="mb-3">
            <label for="event-title" class="form-label"
              >{{ _('Event Title') }}</label
            >
            <input
              type="text"
              class="form-control"
              id="event-title"
              name="title"
              required
            />
          </div>
          <div class="mb-3">
            <label for="event-hour" class="form-label">{{ _('Time') }}</label>
            <div class="input-group">
              <select class="form-select" id="event-hour" aria-label="Hour">
                {% for i in range(24) %}
                <option value="{{ '%02d'|format(i) }}">
                  {{ '%02d'|format(i) }}
                </option>
                {% endfor %}
              </select>
              <span class="input-group-text">:</span>
              <select class="form-select" id="event-minute" aria-label="Minute">
                {% for i in range(0, 60, 5) %} {# 5 minute increments #}
                <option value="{{ '%02d'|format(i) }}">
                  {{ '%02d'|format(i) }}
                </option>
                {% endfor %}
              </select>
            </div>
            <!-- This hidden input will hold the combined HH:MM value for the form -->
            <input
              type="hidden"
              id="event-time-hidden"
              name="time"
              value="00:00"
              required
            />
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            {{ _('Cancel') }}
          </button>
          <button type="submit" class="btn btn-primary">
            {{ _('Add Event') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View/Delete Event Modal -->
<div
  class="modal fade"
  id="viewEventModal"
  tabindex="-1"
  aria-labelledby="viewEventModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewEventModalLabel">
          {{ _('Event Details') }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <h4 id="view-event-title" class="mb-3"></h4>
        <p class="lead">
          <i class="bi bi-clock-fill me-2"></i>
          <span id="view-event-time"></span>
        </p>
        <p class="text-muted" style="font-size: 0.9em">
          <i class="bi bi-person-fill me-2"></i>
          {{ _('Added by') }} <strong id="view-event-author"></strong>
        </p>
      </div>
      <div class="modal-footer justify-content-between">
        <!-- Actions for the event's author -->
        <div id="event-author-actions">
          <button type="button" id="edit-event-btn" class="btn btn-primary">
            <i class="bi bi-pencil-square me-2"></i>{{ _('Edit') }}
          </button>
          <button
            type="button"
            id="delete-event-btn"
            class="btn btn-outline-danger"
          >
            <i class="bi bi-trash me-2"></i>{{ _('Delete Event') }}
          </button>
        </div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          {{ _('Close') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden form for deletion (re-uses existing confirm-delete logic) -->
<form
  action="{{ url_for('delete_event') }}"
  method="POST"
  class="d-none event-delete-form confirm-delete"
>
  <input type="hidden" name="event_id" id="delete-event-id-input" value="" />
</form>
<!-- ================================================================== -->
<!-- END: MODALS & FORMS                                              -->
<!-- ================================================================== -->

<!-- ================================================================== -->
<!-- START: MOBILE FLOATING ACTION BUTTON (FAB)                       -->
<!-- ================================================================== -->
<button
  type="button"
  class="btn btn-primary btn-fab d-lg-none"
  data-bs-toggle="modal"
  data-bs-target="#addEventModal"
  id="mobile-add-event-fab"
>
  <i class="bi bi-plus-lg"></i>
</button>
<!-- ================================================================== -->
<!-- END: MOBILE FLOATING ACTION BUTTON                               -->
<!-- ================================================================== -->

{% endblock %}
