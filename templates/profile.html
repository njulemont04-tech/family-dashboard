{% extends 'base.html' %} {% block title %}{{ _('My Profile') }}{% endblock %}
{% block content %} {% set page_title = _('My Profile') %} {% include
'_feature_header.html' %}

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %} {% if messages
%} {% for category, message in messages %}
<div
  class="alert alert-{{ category }} alert-dismissible fade show"
  role="alert"
>
  {{ message }}
  <button
    type="button"
    class="btn-close"
    data-bs-dismiss="alert"
    aria-label="{{ _('Close') }}"
  ></button>
</div>
{% endfor %} {% endif %} {% endwith %}

<div class="row g-4">
  <!-- Left Column: Avatar Management -->
  <div class="col-lg-4">
    <div class="card">
      <div class="card-body text-center">
        <h5 class="card-title">{{ _('Profile Picture') }}</h5>
        <img
          src="{{ current_user.avatar_url }}"
          alt="{{ _('User Avatar') }}"
          class="img-fluid rounded-circle mb-3"
          style="width: 150px; height: 150px; object-fit: cover"
        />
        <p class="card-text"><strong>{{ current_user.username }}</strong></p>

        <form
          action="{{ url_for('upload_avatar') }}"
          method="POST"
          enctype="multipart/form-data"
        >
          <div class="mb-3">
            <label for="avatar" class="form-label"
              >{{ _('Upload a new picture:') }}</label
            >
            <input
              class="form-control"
              type="file"
              id="avatar"
              name="avatar"
              required
            />
          </div>
          <button type="submit" class="btn btn-primary">
            {{ _('Upload') }}
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Right Column: Account & Family Settings -->
  <div class="col-lg-8">
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">{{ _('Change Password') }}</h5>
        <form action="{{ url_for('change_password') }}" method="POST">
          <div class="mb-3">
            <label for="old_password" class="form-label"
              >{{ _('Old Password') }}</label
            >
            <input
              type="password"
              class="form-control"
              id="old_password"
              name="old_password"
              required
            />
          </div>
          <div class="mb-3">
            <label for="new_password" class="form-label"
              >{{ _('New Password') }}</label
            >
            <input
              type="password"
              class="form-control"
              id="new_password"
              name="new_password"
              required
            />
          </div>
          <button type="submit" class="btn btn-success">
            {{ _('Save New Password') }}
          </button>
        </form>
      </div>
    </div>

    <!-- The Language Settings Card has been REMOVED from here -->

    <!-- START: NEW HOUSEHOLD MEMBERS CARD -->
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">{{ _('Household Members') }}</h5>
        {% if current_user.id == current_family.owner_id %}
        <button
          class="btn btn-sm btn-primary"
          data-bs-toggle="modal"
          data-bs-target="#inviteUserModal"
        >
          <i class="bi bi-person-plus-fill me-1"></i> {{ _('Invite Member') }}
        </button>
        {% endif %}
      </div>
      <ul class="list-group list-group-flush">
        {% for member in current_members %}
        <li class="list-group-item d-flex align-items-center">
          <img
            src="{{ member.avatar_url }}"
            class="rounded-circle me-3"
            width="40"
            height="40"
            alt="{{ _('%(username)s\'s avatar', username=member.username) }}"
          />
          <div>
            <strong>{{ member.username }}</strong>
            {% if member.id == current_family.owner_id %}<span
              class="badge bg-secondary ms-2"
              >{{ _('Admin') }}</span
            >{% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
    <!-- END: NEW HOUSEHOLD MEMBERS CARD -->
  </div>
</div>

<!-- MODAL FOR INVITING USERS (for Admin only) -->
{% if current_user.id == current_family.owner_id %}
<div
  class="modal fade"
  id="inviteUserModal"
  tabindex="-1"
  aria-labelledby="inviteUserModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="inviteUserModalLabel">
          {{ _('Invite a New Member') }}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="{{ _('Close') }}"
        ></button>
      </div>
      <form
        action="{{ url_for('invite_user') }}"
        method="POST"
        class="invite-user-form"
      >
        <div class="modal-body">
          <p>
            {{ _('Select a registered user to invite to your private family
            space. They will gain access to all shared features.') }}
          </p>
          <div class="mb-3">
            <label for="invite-user-select" class="form-label"
              >{{ _('User to Invite') }}</label
            >
            <select
              class="form-select"
              id="invite-user-select"
              name="username"
              required
            >
              <!-- Options will be populated by JavaScript -->
              <option value="" disabled selected>
                {{ _('Choose a user...') }}
              </option>
              {% for user in inviteable_users %}
              <option value="{{ user.username }}">{{ user.username }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            {{ _('Cancel') }}
          </button>
          <button type="submit" class="btn btn-primary">
            {{ _('Send Invite') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %} {% endblock %}
