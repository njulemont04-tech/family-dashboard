{% extends 'base.html' %} {# 1. Import our reusable macro file #} {% from
'_macros.html' import feature_header %} {% block title %}{{ _('Meal Planner')
}}{% endblock %} {% block content %} {# 2. Call the feature_header macro. The
week navigation is placed inside the 'call' block. #} {% call
feature_header(_('Meal Planner')) %}
<div class="btn-group">
  <a
    href="{{ url_for('meal_planner', week_offset=0) }}"
    class="btn btn-outline-primary {% if week_offset == 0 %}active{% endif %}"
    >{{ _("This Week") }}</a
  >
  <a
    href="{{ url_for('meal_planner', week_offset=1) }}"
    class="btn btn-outline-primary {% if week_offset == 1 %}active{% endif %}"
    >{{ _("Next Week") }}</a
  >
</div>
{% endcall %} {# 3. All old title and navigation blocks have been removed. #}

<div class="row g-4" id="meal-board">
  {% for day_info in week_schedule %} {% set meal = meal_plan.get(day_info.name)
  %} {% set is_past = (day_info.date < today and week_offset == 0) %} {# Logic
  for past days added #}

  <div class="col-lg-4 col-md-6">
    <div
      class="card h-100 meal-day-card day-{{ day_info.name|lower }} {% if meal %}meal-planned{% endif %} {% if is_past %}past-day{% endif %}"
    >
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">{{ _(day_info.name) }}</h5>
          <small class="text-muted"
            >{{ day_info.date.strftime('%b %d') }}</small
          >
        </div>
      </div>
      <div
        class="card-body d-flex flex-column justify-content-center text-center meal-card-body"
        {%
        if
        not
        is_past
        %}
        data-bs-toggle="modal"
        data-bs-target="#mealModal"
        data-day="{{ day_info.name }}"
        data-meal-id="{{ meal.id if meal else '' }}"
        style="cursor: pointer"
        {%
        endif
        %}
      >
        {% if meal %}
        <p class="fs-5 mb-1 meal-description">{{ meal.description }}</p>
        {% if meal.notes %}
        <div class="meal-notes-indicator">
          <i class="bi bi-info-circle-fill"></i>
        </div>
        {% endif %} {% else %} {% if is_past %}
        <p class="text-muted mt-2 mb-0">-</p>
        {% else %}
        <div class="meal-empty-state">
          <i class="bi bi-plus-circle display-6 text-muted"></i>
          <p class="text-muted mt-2 mb-0">{{ _('Add a meal') }}</p>
        </div>
        {% endif %} {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Reusable Meal Modal (Structure remains the same) -->
<div
  class="modal fade"
  id="mealModal"
  tabindex="-1"
  aria-labelledby="mealModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form id="meal-form">
        <div class="modal-header">
          <h5 class="modal-title" id="mealModalLabel">{{ _('Edit Meal') }}</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="{{ _('Close') }}"
          ></button>
        </div>
        <div class="modal-body">
          <input
            type="hidden"
            id="meal-week-of-input"
            name="week_of"
            value="{{ start_of_target_week.isoformat() }}"
          />
          <input type="hidden" id="meal-day-input" name="day" value="" />
          <div class="mb-3">
            <label for="meal-description-input" class="form-label"
              >{{ _('Dinner Plan') }}</label
            >
            <textarea
              class="form-control"
              id="meal-description-input"
              name="description"
              rows="3"
              placeholder="{{ _('e.g., Spaghetti Bolognese') }}"
              required
            ></textarea>
          </div>
          <div class="mb-3">
            <label for="meal-notes-input" class="form-label"
              >{{ _('Notes (Recipe, Link, etc.)') }}</label
            >
            <textarea
              class="form-control"
              id="meal-notes-input"
              name="notes"
              rows="5"
              placeholder="{{ _('Optional: Add a recipe link or preparation notes here.') }}"
            ></textarea>

            <!-- === ADD THIS NEW BLOCK BELOW THE TEXTAREA === -->
            <div
              id="meal-notes-links-preview"
              class="mt-2 p-3 bg-light rounded border d-none"
            >
              <small class="text-muted d-block mb-1 fw-bold"
                >{{ _('Clickable Links:') }}</small
              >
              <!-- Links will be injected here by JavaScript -->
              <div id="meal-notes-content" style="word-break: break-word"></div>
            </div>
            <!-- ============================================ -->
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <button
            type="button"
            id="delete-meal-button"
            class="btn btn-outline-danger"
          >
            {{ _('Remove') }}
          </button>
          <div>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              {{ _('Cancel') }}
            </button>
            <button type="submit" form="meal-form" class="btn btn-primary">
              {{ _('Save') }}
            </button>
          </div>
        </div>
      </form>
      <form
        id="delete-meal-form"
        class="confirm-delete"
        action="{{ url_for('delete_meal') }}"
        method="POST"
        style="display: none"
      >
        <input
          type="hidden"
          id="delete-meal-id-input"
          name="meal_id"
          value=""
        />
        <button type="submit" id="confirm-delete-submit-button"></button>
      </form>
    </div>
  </div>
</div>

{% endblock %} {% block page_scripts %}
<script>
  window.mealPlanData = {{ meal_plan_json|safe }};

  // --- ADD THIS NEW BLOCK ---
  window.translations = {
      add_meal: "{{ _('Add a meal') }}" // Jinja will translate this before sending to browser
  };
  // --------------------------
</script>
{% endblock %}
